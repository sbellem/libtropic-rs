use tropic01_example_usb::ChipId;

#[test]
fn test_chip_id_parsing_and_printing() {
    let chip_id: [u8; 101] = [
        // version [0-3]
        0x01, 0x00, 0x00, 0x00,
        // fl_chip_info [4-19]
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // func_test_info [20-27]
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
        // silicon_rev [28-31] = "ACAB"
        0x41, 0x43, 0x41, 0x42,
        // package_type_id [32-33]
        0x80, 0xaa,
        // [34-35] unused/skipped; fill with 0
        0x00, 0x00,
        // prov_info [36-39]
        0x01, 0x00, 0x10, 0x01,
        // provisioning_date [40-41]
        0x08, 0x5b,
        // hsm_ver [42-45]
        0x00, 0x06, 0x05, 0x01,
        // prog_ver [46-49]
        0x00, 0x00, 0x00, 0x00,
        // [50-51] unused/skipped; fill with 0
        0x00, 0x00,
        // serial_number [52-67] -- 16 bytes only!
        0x02, 0x00, 0x11, 0x01, 0x08, 0x5b,
        0x19, 0x05, 0x09, 0x0d, 0x00, 0x00,
        0x00, 0x00, 0x03, 0xeb,
        // part_number [68-83]
        0x0d, // length = 13
        0x54, 0x52, 0x30, 0x31, 0x2d, 0x43, 0x32, 0x50, 0x2d, 0x54, 0x31, 0x30, 0x31,
        0xff, 0xff,  // pad with 0xFF
        // prov_templ_ver [84-85]
        0x01, 0x04,
        // prov_templ_tag [86-89]
        0xd8, 0x96, 0x61, 0x28,
        // prov_spec_ver [90-91]
        0x00, 0x0c,
        // prov_spec_tag [92-95]
        0x7d, 0xed, 0xa8, 0x70,
        // batch_id [96-100]
        0x19, 0x05, 0x09, 0x0d, 0x00,
    ];

    let chip = ChipId::try_from(&chip_id[..]).expect("Should parse chip ID");

    assert_eq!(chip.version, [0x01, 0x00, 0x00, 0x00]);
    assert_eq!(chip.fl_chip_info, [0; 16]);
    assert_eq!(chip.func_test_info, [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff]);
    assert_eq!(chip.silicon_rev, [0x41, 0x43, 0x41, 0x42]);
    assert_eq!(chip.package_type_id, [0x80, 0xaa]);
    assert_eq!(chip.prov_info, [0x01, 0x00, 0x10, 0x01]);
    assert_eq!(chip.provisioning_date, [0x08, 0x5b]);
    assert_eq!(chip.hsm_ver, [0x00, 0x06, 0x05, 0x01]);
    assert_eq!(chip.prog_ver, [0x00, 0x00, 0x00, 0x00]);
    assert_eq!(chip.serial_number, [
        0x02, 0x00, 0x11, 0x01, 0x08, 0x5b,
        0x19, 0x05, 0x09, 0x0d, 0x00, 0x00,
        0x00, 0x00, 0x03, 0xeb,
    ]);
    assert_eq!(chip.part_number[0], 0x0d); // length
    assert_eq!(&chip.part_number[1..14], b"TR01-C2P-T101"); // ASCII
    assert_eq!(chip.part_number[14], 0xff);
    assert_eq!(chip.part_number[15], 0xff);
    assert_eq!(chip.prov_templ_ver, [0x01, 0x04]);
    assert_eq!(chip.prov_templ_tag, [0xd8, 0x96, 0x61, 0x28]);
    assert_eq!(chip.prov_spec_ver, [0x00, 0x0c]);
    assert_eq!(chip.prov_spec_tag, [0x7d, 0xed, 0xa8, 0x70]);
    assert_eq!(chip.batch_id, [0x19, 0x05, 0x09, 0x0d, 0x00]);
}
